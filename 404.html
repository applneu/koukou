// _worker.js —— 中继（Cloudflare Pages Functions）
// 作用：接收浏览器请求 `/api/resolve?enc=...`，转发到“核心 Worker”的 `/resolve`，
//      并在响应上加 CORS 头，允许 GitHub Pages 跨域访问。

// 多个核心 Worker（随机挑一个）
const CORES = [
  "https://zhongji-wb3.pages.dev",
  "https://zhongji-wb3.pages.dev",
  // 可以继续加…
];

// 中继→核心的识别头（核心要求有此头）
const RELAY_HEADER_NAME = "X-Relay";
const RELAY_HEADER_VALUE = "1";

// 允许哪些前端域跨域访问中继（调试可先用 "*"，通了再收紧）
const ALLOW_ORIGINS = [
  "https://applneu.github.io",
  // "https://你的自定义pages域",
  // "*", // ← 仅调试用
];

export default {
  async fetch(req, env) {
    const url = new URL(req.url);

    // 处理 CORS 预检
    if (req.method === "OPTIONS") {
      return cors(req, new Response(null, { status: 204 }));
    }

    // 只开放 /api/resolve
    if (url.pathname === "/api/resolve") {
      // 随机选择一个核心
      const core = CORES[Math.floor(Math.random() * CORES.length)];
      const to = new URL("/resolve" + url.search, core).toString();

      // 转发到核心（只带我们需要的头）
      const upstream = await fetch(to, {
        method: "GET",
        headers: { [RELAY_HEADER_NAME]: RELAY_HEADER_VALUE },
      });

      // 取回核心响应体，再加上 CORS 头返回给浏览器
      const body = await upstream.text();
      const resp = new Response(body, {
        status: upstream.status,
        headers: {
          "Content-Type":
            upstream.headers.get("Content-Type") ||
            "application/json; charset=utf-8",
          "Cache-Control": "no-store",
        },
      });
      return cors(req, resp);
    }

    // 其余路径交给静态资源（若此 Pages 有静态文件）
    return env.ASSETS ? env.ASSETS.fetch(req) : new Response("Not found", { status: 404 });
  },
};

// 给响应加 CORS 头（按请求 Origin 动态返回）
function cors(req, resp) {
  const origin = req.headers.get("Origin") || "";
  const allowed =
    ALLOW_ORIGINS.includes("*") || ALLOW_ORIGINS.includes(origin) ? origin : "";

  const h = new Headers(resp.headers);
  if (allowed) h.set("Access-Control-Allow-Origin", allowed);
  h.set("Vary", "Origin");
  h.set("Access-Control-Allow-Methods", "GET,OPTIONS");
  h.set("Access-Control-Allow-Headers", "Content-Type");
  h.set("Access-Control-Max-Age", "86400");

  return new Response(resp.body, { status: resp.status, headers: h });
}
